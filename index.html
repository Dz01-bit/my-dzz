<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no"> 
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Dzz">
    <title>Dzz</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

    <style>
        /* --- ğŸ¨ é…è‰² --- */
        :root {
            --bg-color: #F7F9F7;
            --card-bg: #FFFFFF;
            --theme-dark: #556b2f;
            --theme-light: #eaf1ea;
            --text-main: #333333;
            --text-sub: #999999; /* æµ…ç° */
            --danger: #b71c1c; 
            --highlight: #2e7d32; 
            --border-color: #d0d0d0;
            --badge-bg: #f0f2f0;
        }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif; 
            background-color: var(--bg-color); 
            margin: 0; padding: 0; 
            padding-top: env(safe-area-inset-top); 
            padding-bottom: 100px; 
            color: var(--text-main);
            user-select: none; -webkit-user-select: none;
        }

        /* é¡¶éƒ¨ */
        .header { 
            padding: 12px 15px; 
            background: rgba(255,255,255,0.98);
            border-bottom: 1px solid var(--border-color);
            position: sticky; top: 0; z-index: 100;
            display: flex; align-items: center; justify-content: space-between;
        }
        h1 { margin: 0; font-size: 20px; font-weight: 700; color: var(--theme-dark); letter-spacing: 1px;}
        .date-str { font-size: 11px; color: var(--text-sub); }

        /* æ¿å— */
        .section-block { 
            background: var(--card-bg); margin: 10px 12px; border-radius: 10px; 
            padding: 0 10px 10px 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.04); 
        }
        .section-header-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 5px; border-bottom: 1px solid var(--theme-light); cursor: pointer;
        }
        .sec-title-group { display: flex; align-items: center; gap: 8px; flex: 1; }
        .section-title { font-size: 15px; font-weight: bold; color: var(--theme-dark); padding: 2px 6px; border-radius: 4px;}
        .section-count { font-size: 11px; color: #fff; background: var(--theme-dark); padding: 1px 6px; border-radius: 10px; opacity: 0.8;}
        .section-arrow { font-size: 10px; color: var(--text-sub); transition: 0.2s; }
        .section-arrow.collapsed { transform: rotate(-90deg); }
        .section-content { transition: all 0.3s; }
        .section-content.collapsed { display: none; }
        .del-section-btn { font-size: 16px; color: #555; padding: 5px; font-weight: bold;}

        /* --- ä»»åŠ¡åˆ—è¡¨é¡¹ --- */
        .task-list-area { min-height: 20px; }
        .task-item { 
            border-bottom: 1px solid #f0f0f0; 
            padding: 12px 0;
            background: white; 
            position: relative;
        }

        /* ç¬¬ä¸€è¡Œå®¹å™¨ï¼šå¤é€‰æ¡† + (æ ‡é¢˜+æ—¥æœŸ) */
        .task-row-top { display: flex; align-items: flex-start; }
        
        .checkbox { 
            width: 16px; height: 16px; 
            border: 2px solid var(--theme-dark); 
            border-radius: 5px; 
            margin-right: 10px; margin-top: 3px; /* å¾®è°ƒå¯¹é½ */
            flex-shrink: 0; display: flex; align-items: center; justify-content: center; cursor: pointer; 
            background: #fff;
        }
        .checkbox.checked { background: var(--theme-dark); }
        .checkbox.checked::after { content: 'âœ“'; color: white; font-size: 10px; }

        .task-main-content { flex: 1; min-width: 0; line-height: 1.5; }
        
        /* æ ‡é¢˜ä¸æ—¥æœŸè¡Œå†…æ˜¾ç¤º */
        .title-date-inline-wrapper { display: inline; }
        
        /* æ ‡é¢˜å­—ä½“ç¼©å° */
        .task-name { 
            font-size: 15px; /* ç¼©å°å­—ä½“ */
            color: var(--text-main); font-weight: 500; 
            margin-right: 8px; cursor: pointer; display: inline;
        }
        
        /* --- ğŸ“… æ—¥æœŸæ ·å¼ (è¡Œå†…) --- */
        .date-inline-container {
            display: inline; font-size: 12px; color: var(--text-sub);
        }
        
        .date-label { font-size: 11px; color: #aaa; margin-right: 2px; margin-left: 4px;}
        .date-val { font-family: -apple-system, monospace; font-weight: 500; }
        
        /* é¢œè‰²çŠ¶æ€ç±» */
        .date-gray { color: #999; } /* æœªå¼€å§‹ */
        .date-green { color: var(--highlight); font-weight: bold; } /* è¿›è¡Œä¸­ */
        .date-red { color: var(--danger); font-weight: bold; } /* è¿‡æœŸ */

        /* èƒ¶å›Šæ ‡ç­¾ (è¡Œå†…) */
        .date-badge { 
            display: inline-flex; align-items: center; justify-content: center;
            padding: 0 5px; border-radius: 4px; font-size: 10px; 
            height: 18px; margin: 0 4px; vertical-align: text-bottom;
        }
        .badge-gray { background: #f5f5f5; color: #999; }     /* ç°è‰² (æœªå¼€å§‹/å…±Xå¤©) */
        .badge-green { background: #e8f5e9; color: #2e7d32; } /* ç»¿è‰² (è¿›è¡Œä¸­) */
        .badge-red { background: #ffebee; color: #c62828; }   /* çº¢è‰² (è¿‡æœŸ) */

        /* --- ğŸ“ å¤‡æ³¨æ ·å¼ --- */
        .task-note-middle {
            font-size: 12px; color: #888; 
            margin-top: 2px; margin-bottom: 4px; 
            display: block;
        }

        /* --- ğŸ“Š è¿›åº¦æ¡æ ·å¼ --- */
        .progress-area { margin-top: 6px; }
        .prog-bar-track {
            position: relative; height: 8px; background: #eee; border-radius: 4px;
            overflow: hidden; margin-bottom: 4px;
        }
        .prog-bar-fill {
            height: 100%; background: var(--theme-dark);
            width: 0%; transition: width 0.2s; border-radius: 4px;
        }
        .prog-slider {
            position: absolute; top: -5px; left: 0; width: 100%; height: 20px;
            opacity: 0; cursor: col-resize; z-index: 2;
        }
        .prog-controls-row {
            display: flex; justify-content: flex-end; align-items: center; gap: 8px;
        }
        .prog-text-display { font-size: 11px; font-weight: bold; color: var(--theme-dark); }
        .prog-btn {
            width: 20px; height: 20px; background: #f0f0f0; color: #333;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 12px; cursor: pointer; border: 1px solid #ddd;
        }

        /* åˆ é™¤æŒ‰é’® */
        .del-task-btn { color: #ccc; font-size: 16px; margin-left: 8px; padding: 0 4px; cursor: pointer; margin-top: 2px;}
        .del-task-btn:active { color: var(--danger); }

        .task-img { max-width: 80px; max-height: 80px; border-radius: 4px; margin-top: 4px; border: 1px solid #eee; display: block;}
        
        .subtask-item { display: flex; align-items: center; margin: 4px 0; cursor: pointer; }
        .subtask-check { width: 12px; height: 12px; border: 1px solid #888; border-radius: 3px; margin-right: 6px; display: flex; align-items: center; justify-content: center; font-size: 10px;}
        .subtask-check.done { background: #ccc; border-color: #ccc; color: #fff;}
        .subtask-text { font-size: 13px; color: #555; }
        .subtask-text.done { text-decoration: line-through; color: #aaa; }

        .completed-section { margin-top: 10px; padding-top: 8px; border-top: 2px dashed #eee; }
        .completed-header { font-size: 13px; color: #888; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: 500;}
        .clear-btn { background: #fff; border: 1px solid var(--danger); color: var(--danger); font-size: 11px; padding: 2px 10px; border-radius: 12px; font-weight: bold;}

        .add-btn-circle {
            width: 32px; height: 32px; border-radius: 50%;
            background: var(--theme-light); color: var(--theme-dark);
            display: flex; align-items: center; justify-content: center;
            margin: 12px auto 0; cursor: pointer; font-size: 20px; font-weight: 300; border: 1px solid var(--border-color);
        }

        .global-actions { text-align: center; margin: 20px 0; }
        .action-pill { background: white; border: 1px solid #aaa; color: #333; padding: 8px 16px; border-radius: 20px; font-size: 13px; margin: 0 5px; font-weight: 500;}

        /* å¼¹çª— */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 1000; display: none; align-items: flex-end; }
        .modal { background: white; width: 100%; border-top-left-radius: 16px; border-top-right-radius: 16px; padding: 20px; max-height: 90vh; overflow-y: auto; }
        .form-group { margin-bottom: 15px; }
        .form-label { font-size: 14px; font-weight: bold; color: var(--theme-dark); margin-bottom: 6px; display: block;}
        .form-input { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; font-size: 16px; box-sizing: border-box;}
        textarea.form-input { height: 70px; font-family: inherit; }
        .row-inputs { display: flex; gap: 10px; }
        .modal-buttons { display: flex; gap: 10px; margin-top: 20px; }
        .btn { flex: 1; padding: 12px; border: none; border-radius: 8px; font-size: 15px; font-weight: bold; }
        .btn-cancel { background: #f0f0f0; color: #555; }
        .btn-save { background: var(--theme-dark); color: white; }
    </style>
</head>
<body>

    <div class="header">
        <h1>Dzz</h1>
        <div class="date-str" id="dateDisplay">...</div>
    </div>

    <div id="mainContainer" style="display:none;"></div>

    <div class="global-actions" id="globalActions" style="display:none;">
        <button class="action-pill" onclick="addNewSection()">+ æ–°å¢æ¿å—</button>
        <button class="action-pill" onclick="exportData()">å¤‡ä»½æ•°æ®</button>
        <button class="action-pill" onclick="document.getElementById('importFile').click()">æ¢å¤æ•°æ®</button>
        <input type="file" id="importFile" style="display:none" onchange="importData(this)">
    </div>

    <div class="modal-overlay" id="taskModal">
        <div class="modal">
            <h3 id="modalTitle" style="color:var(--theme-dark); margin-top:0;">ç¼–è¾‘å¾…åŠ</h3>
            <input type="hidden" id="editTaskIndex">
            <input type="hidden" id="editSectionIndex">
            
            <div class="form-group">
                <label class="form-label">å¾…åŠå†…å®¹</label>
                <input type="text" id="inputName" class="form-input">
            </div>
            
            <div class="form-group">
                <label class="form-label">å¤‡æ³¨</label>
                <input type="text" id="inputNote" class="form-input" placeholder="ç®€çŸ­å¤‡æ³¨">
            </div>

            <div class="form-group">
                <label class="form-label">æ—¥æœŸè®¾ç½®</label>
                <div class="row-inputs">
                    <div style="flex:1">
                        <span style="font-size:12px;color:#888">å¼€å§‹æ—¥æœŸ</span>
                        <input type="date" id="inputStartDate" class="form-input">
                    </div>
                    <div style="flex:1">
                        <span style="font-size:12px;color:#888">æˆªæ­¢æ—¥æœŸ</span>
                        <input type="date" id="inputDueDate" class="form-input">
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">è¿›åº¦æ¡è®¾ç½® (ç•™ç©ºåˆ™ä¸ºæ™®é€šä»»åŠ¡)</label>
                <div class="row-inputs" style="margin-bottom:5px;">
                    <input type="number" id="inputCurrent" class="form-input" placeholder="å½“å‰å€¼(0)">
                    <input type="number" id="inputTarget" class="form-input" placeholder="ç›®æ ‡å€¼(å¦‚100)">
                </div>
                <div class="row-inputs">
                    <input type="text" id="inputUnit" class="form-input" placeholder="å•ä½(å¦‚:é¡µ)">
                    <input type="number" id="inputStep" class="form-input" placeholder="æ­¥é•¿(å¦‚1)" value="1">
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">å­ä»»åŠ¡ (æ¯è¡Œä¸€ä¸ª)</label>
                <textarea id="inputSubtasks" class="form-input" placeholder="æ­¥éª¤1&#10;æ­¥éª¤2"></textarea>
            </div>

            <div class="form-group">
                <label class="form-label">å›¾ç‰‡</label>
                <input type="file" id="inputImg" accept="image/*" onchange="handleImageCompressed(this)">
                <input type="hidden" id="imgBase64">
                <div id="imgPreview" style="margin-top:5px;"></div>
            </div>

            <div class="modal-buttons">
                <button class="btn btn-cancel" onclick="closeModal()">å–æ¶ˆ</button>
                <button class="btn btn-save" onclick="saveTask()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <script>
        // --- 1. æ•°æ®åº“ ---
        const DB_NAME = "Dzz_V10_Inline"; const STORE_NAME = "store"; let db;
        const dbEngine = {
            init: () => new Promise((res, rej) => {
                const r = indexedDB.open(DB_NAME, 1);
                r.onupgradeneeded = e => { e.target.result.createObjectStore(STORE_NAME, { keyPath: "id" }); };
                r.onsuccess = e => { db = e.target.result; res(); };
                r.onerror = rej;
            }),
            save: data => new Promise(res => {
                const t = db.transaction([STORE_NAME], "readwrite");
                t.objectStore(STORE_NAME).put({ id: "data", val: data });
                t.oncomplete = res; 
            }),
            load: () => new Promise(res => {
                const t = db.transaction([STORE_NAME], "readonly");
                t.objectStore(STORE_NAME).get("data").onsuccess = e => res(e.target.result?.val);
            })
        };

        let appData = {
            sections: [
                { title: "ä»Šæ—¥ä¸“æ³¨", collapsed: false, tasks: [] },
                { title: "å¤‡å¿˜å½•", collapsed: false, tasks: [] }
            ]
        };

        window.onload = async () => {
            const d = new Date();
            document.getElementById('dateDisplay').innerText = `${d.getFullYear()}å¹´${d.getMonth()+1}æœˆ${d.getDate()}æ—¥`;
            try {
                await dbEngine.init();
                const data = await dbEngine.load();
                if(data) appData = data;
                document.getElementById("mainContainer").style.display = "block";
                document.getElementById("globalActions").style.display = "block";
                renderAll();
            } catch(e) { alert("Error: " + e); }
        };

        // --- æ ¸å¿ƒæ¸²æŸ“ ---
        function renderAll() {
            const container = document.getElementById("mainContainer");
            container.innerHTML = "";

            appData.sections.forEach((section, sIdx) => {
                const block = document.createElement("div");
                block.className = "section-block";
                block.dataset.idx = sIdx;

                const total = section.tasks.length;
                const doneCount = section.tasks.filter(t => t.done).length;

                const header = document.createElement("div");
                header.className = "section-header-row";
                header.innerHTML = `
                    <div class="sec-title-group" onclick="toggleSection(${sIdx})">
                        <div class="section-arrow ${section.collapsed ? 'collapsed' : ''}">â–¼</div>
                        <div class="section-title" contenteditable="true" onclick="event.stopPropagation()">${section.title}</div>
                        <div class="section-count">${doneCount}/${total}</div>
                    </div>
                    <div class="del-section-btn" onclick="deleteSection(${sIdx})">ğŸ—‘</div>
                `;
                header.querySelector('.section-title').onblur = function() {
                    appData.sections[sIdx].title = this.innerText; updateAndSave();
                };
                block.appendChild(header);

                const content = document.createElement("div");
                content.className = "section-content " + (section.collapsed ? "collapsed" : "");

                const list = document.createElement("div");
                list.className = "task-list-area";
                list.dataset.sIdx = sIdx;

                section.tasks.forEach((task, tIdx) => {
                    if(!task.done) {
                        const el = createTaskElement(task, sIdx, tIdx);
                        list.appendChild(el);
                    }
                });

                new Sortable(list, {
                    group: 'dzz', animation: 150, delay: 200, delayOnTouchOnly: true,
                    onEnd: (evt) => handleSort(evt)
                });
                
                content.appendChild(list);

                const doneTasks = section.tasks.filter(t => t.done);
                if(doneTasks.length > 0) {
                    const doneSec = document.createElement("div");
                    doneSec.className = "completed-section";
                    doneSec.innerHTML = `
                        <div class="completed-header" onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display==='none'?'block':'none'">
                            <span>å·²å®Œæˆ</span>
                            <span class="clear-btn" onclick="event.stopPropagation(); clearDone(${sIdx})">Clear</span>
                        </div>
                        <div class="completed-list" style="display:none; margin-top:5px;"></div>
                    `;
                    const doneList = doneSec.querySelector('.completed-list');
                    section.tasks.forEach((task, tIdx) => {
                        if(task.done) doneList.appendChild(createTaskElement(task, sIdx, tIdx));
                    });
                    content.appendChild(doneSec);
                }

                const addBtn = document.createElement("div");
                addBtn.className = "add-btn-circle";
                addBtn.innerHTML = "+";
                addBtn.onclick = () => openModal(sIdx);
                content.appendChild(addBtn);

                block.appendChild(content);
                container.appendChild(block);
            });
        }

        // --- æ ¸å¿ƒï¼šä»»åŠ¡é¡¹ HTML ---
        function createTaskElement(task, sIdx, tIdx) {
            const div = document.createElement("div");
            div.className = "task-item";
            
            // ğŸ“… æ—¶é—´è½´é€»è¾‘ (è¡Œå†…ç‰ˆ)
            let dateHTML = "";
            if(task.dueDate || task.startDate) {
                const now = new Date(); now.setHours(0,0,0,0);
                
                // 1. åˆå§‹åŒ–å˜é‡
                let preTag = "";    
                let startTag = "";  
                let midTag = "";    
                let dueTag = "";    
                let postTag = "";   

                // é»˜è®¤é¢œè‰²ï¼šæœªå¼€å§‹=ç°è‰²
                let startClass = "date-val date-gray"; 
                let dueClass = "date-val date-gray";
                let preBadgeClass = "badge-gray"; // é»˜è®¤æœªå¼€å§‹èƒ¶å›Šç°è‰²

                // 2. Start Date å¤„ç†
                if(task.startDate) {
                    const sd = new Date(task.startDate); sd.setHours(0,0,0,0);
                    const formattedStart = `${sd.getFullYear()}.${(sd.getMonth()+1).toString().padStart(2,'0')}.${sd.getDate().toString().padStart(2,'0')}`;
                    
                    // çŠ¶æ€åˆ¤æ–­
                    if(now < sd) {
                        // æœªå¼€å§‹ï¼šå…¨ç°
                        const diff = Math.ceil((sd - now)/86400000);
                        preTag = `<span class="date-badge ${preBadgeClass}">è¿˜æœ‰ ${diff} å¤©å¼€å§‹</span>`;
                    } else {
                        // å½“æ—¥æˆ–å·²å¼€å§‹ï¼šå˜ç»¿
                        startClass = "date-val date-green";
                        if(now.getTime() === sd.getTime()) startClass += " hl-green"; // é¢å¤–åŠ ç²—
                    }

                    // å¦‚æœå¤„äºåŒºé—´å†…
                    if(task.dueDate) {
                        const dd = new Date(task.dueDate); dd.setHours(0,0,0,0);
                        if(now >= sd && now <= dd) {
                            // è¿›è¡Œä¸­ï¼šå…¨ç»¿
                            startClass = "date-val date-green"; 
                            dueClass = "date-val date-green"; // æˆªæ­¢æ—¥æœŸä¹Ÿå˜ç»¿æé†’
                            
                            const diff = Math.ceil((dd - now)/86400000);
                            let txt = diff===0 ? "ä»Šå¤©æˆªæ­¢" : `å‰© ${diff} å¤©`;
                            // å‰©ä½™å¤©æ•°ç”¨ç»¿è‰²èƒ¶å›Š
                            preTag = `<span class="date-badge badge-green">${txt}</span>`;
                        }
                        // é—´éš” (ç°)
                        const dur = Math.ceil((dd - sd)/86400000);
                        midTag = `<span class="date-badge badge-gray">å…± ${dur} å¤©</span>`;
                    }

                    startTag = `<span class="date-label">Start</span><span class="${startClass}">${formattedStart}</span>`;
                }

                // 3. Deadline å¤„ç†
                if(task.dueDate) {
                    const dd = new Date(task.dueDate); dd.setHours(0,0,0,0);
                    const formattedDue = `${dd.getFullYear()}.${(dd.getMonth()+1).toString().padStart(2,'0')}.${dd.getDate().toString().padStart(2,'0')}`;
                    
                    const diff = Math.ceil((dd - now)/86400000);

                    if(now > dd && !task.done) {
                        // è¿‡æœŸï¼šçº¢
                        postTag = `<span class="date-badge badge-red">è¿‡æœŸ ${Math.abs(diff)} å¤©</span>`;
                    } else if (now.getTime() === dd.getTime()) {
                        // æˆªæ­¢å½“æ—¥ï¼šçº¢
                        dueClass = "date-val date-red"; 
                        if(!preTag) preTag = `<span class="date-badge badge-red">ä»Šå¤©æˆªæ­¢</span>`;
                    } else if (!task.startDate && !preTag && diff >= 0) {
                        // åªæœ‰æˆªæ­¢æ—¥æœŸï¼Œæ²¡å¼€å§‹æ—¥æœŸï¼Œæ²¡è¿‡æœŸ -> ç»¿è‰²å‰©Xå¤©
                        preTag = `<span class="date-badge badge-green">å‰© ${diff} å¤©</span>`;
                        dueClass = "date-val date-green"; // æ—¢ç„¶åœ¨å€’è®¡æ—¶ï¼Œæ—¥æœŸä¹Ÿäº®èµ·æ¥
                    }

                    // å¦‚æœå¤„äºåŒºé—´ (åœ¨Starté‡Œå·²å˜ç»¿ï¼Œè¿™é‡Œå¦‚æœStartä¸å­˜åœ¨ï¼Œä¿æŒä¸Šé¢é€»è¾‘)
                    
                    dueTag = `<span class="date-label">Deadline</span><span class="${dueClass}">${formattedDue}</span>`;
                }

                dateHTML = `
                    <span class="date-inline-container">
                        ${preTag} ${startTag} ${midTag} ${dueTag} ${postTag}
                    </span>
                `;
            }

            const hasProgress = (task.targetVal && task.targetVal > 0);
            
            // --- å†…å®¹æ‹¼æ¥ ---
            let noteHTML = task.note ? `<span class="task-note-middle">${task.note}</span>` : '';
            
            let bottomContent = '';
            if (hasProgress && !task.done) {
                const pct = Math.min(100, Math.round((task.currentVal / task.targetVal) * 100));
                bottomContent = `
                    <div class="progress-area">
                        <div class="prog-bar-track">
                            <div class="prog-bar-fill" style="width: ${pct}%"></div>
                            <input type="range" class="prog-slider" min="0" max="${task.targetVal}" step="${task.stepVal||1}" value="${task.currentVal}" onchange="updateProgVal(${sIdx}, ${tIdx}, this.value)">
                        </div>
                        <div class="prog-controls-row">
                            <div class="prog-text-display">${pct}% | ${task.currentVal}/${task.targetVal} ${task.unit||''}</div>
                            <div class="prog-btn" onclick="adjustProg(${sIdx}, ${tIdx}, -1)">-</div>
                            <div class="prog-btn" onclick="adjustProg(${sIdx}, ${tIdx}, 1)">+</div>
                        </div>
                    </div>
                `;
            }

            let extraHTML = `
                ${renderSubtasks(task.subtasks, sIdx, tIdx)}
                ${task.img ? `<img src="${task.img}" class="task-img">` : ''}
            `;

            div.innerHTML = `
                <div class="task-row-top">
                    <div class="checkbox ${task.done?'checked':''}" onclick="toggleTask(${sIdx}, ${tIdx})"></div>
                    <div class="task-main-content">
                        <div class="title-date-inline-wrapper">
                            <div class="task-name" onclick="openModal(${sIdx}, ${tIdx})">${task.name}</div>
                            ${dateHTML}
                        </div>
                        
                        ${noteHTML}
                        ${bottomContent}
                        ${extraHTML}
                    </div>
                    <div class="del-task-btn" onclick="delTask(${sIdx}, ${tIdx})">Ã—</div>
                </div>
            `;
            
            return div;
        }

        function renderSubtasks(text, sIdx, tIdx) {
            if(!text) return '';
            const lines = text.split('\n');
            let html = '<div style="margin:4px 0;">';
            lines.forEach((line, lineIdx) => {
                if(!line.trim()) return;
                const isDone = line.trim().startsWith('[x]');
                const cleanText = line.replace(/^\[x\]|\[ \]/, '').trim();
                html += `
                    <div class="subtask-item" onclick="toggleSubtask(${sIdx}, ${tIdx}, ${lineIdx})">
                        <div class="subtask-check ${isDone?'done':''}">${isDone?'âœ“':''}</div>
                        <div class="subtask-text ${isDone?'done':''}">${cleanText}</div>
                    </div>
                `;
            });
            html += '</div>';
            return html;
        }

        // --- é€»è¾‘æ“ä½œ ---
        function updateAndSave() { renderAll(); dbEngine.save(appData); }
        function toggleSection(idx) { appData.sections[idx].collapsed = !appData.sections[idx].collapsed; updateAndSave(); }
        
        function toggleTask(s, t) { 
            if (!appData.sections[s] || !appData.sections[s].tasks[t]) return;
            appData.sections[s].tasks[t].done = !appData.sections[s].tasks[t].done; 
            updateAndSave(); 
        }

        function delTask(s, t) { 
            if (!appData.sections[s] || !appData.sections[s].tasks[t]) return;
            appData.sections[s].tasks.splice(t, 1); 
            updateAndSave(); 
        }

        function clearDone(s) { 
            appData.sections[s].tasks = appData.sections[s].tasks.filter(t => !t.done); 
            updateAndSave(); 
        }
        
        function updateProgVal(s, t, val) {
            if (!appData.sections[s].tasks[t]) return;
            appData.sections[s].tasks[t].currentVal = parseFloat(val);
            updateAndSave();
        }
        
        function adjustProg(s, t, dir) {
            if (!appData.sections[s].tasks[t]) return;
            const task = appData.sections[s].tasks[t];
            const step = parseFloat(task.stepVal) || 1;
            let val = parseFloat(task.currentVal) || 0;
            val += (dir * step);
            if(val < 0) val = 0;
            if(val > task.targetVal) val = task.targetVal;
            task.currentVal = val;
            updateAndSave();
        }

        function toggleSubtask(s, t, lineIdx) {
            if (!appData.sections[s].tasks[t]) return;
            let text = appData.sections[s].tasks[t].subtasks;
            let lines = text.split('\n');
            let line = lines[lineIdx];
            if(line.trim().startsWith('[x]')) lines[lineIdx] = line.replace('[x]', '').trim();
            else lines[lineIdx] = '[x] ' + line.trim();
            appData.sections[s].tasks[t].subtasks = lines.join('\n');
            updateAndSave();
        }

        function handleSort(evt) {
            const oldS = parseInt(evt.from.dataset.sIdx);
            const newS = parseInt(evt.to.dataset.sIdx);
            const oldIdx = evt.oldIndex;
            const newIdx = evt.newIndex;
            
            const sourceUndone = appData.sections[oldS].tasks.filter(t => !t.done);
            const item = sourceUndone[oldIdx];
            if (!item) return updateAndSave();

            const trueIdx = appData.sections[oldS].tasks.indexOf(item);
            appData.sections[oldS].tasks.splice(trueIdx, 1);

            if(oldS === newS) {
                const currUndone = appData.sections[oldS].tasks.filter(t => !t.done);
                if(newIdx >= currUndone.length) appData.sections[oldS].tasks.push(item);
                else {
                    const ref = currUndone[newIdx];
                    appData.sections[oldS].tasks.splice(appData.sections[oldS].tasks.indexOf(ref), 0, item);
                }
            } else {
                const targetUndone = appData.sections[newS].tasks.filter(t => !t.done);
                if(newIdx >= targetUndone.length) appData.sections[newS].tasks.push(item);
                else {
                    const ref = targetUndone[newIdx];
                    appData.sections[newS].tasks.splice(appData.sections[newS].tasks.indexOf(ref), 0, item);
                }
            }
            updateAndSave();
        }

        // --- å¼¹çª—ä¸å›¾ç‰‡ ---
        function openModal(sIdx, tIdx = null) {
            document.getElementById("editSectionIndex").value = sIdx;
            document.getElementById("editTaskIndex").value = tIdx !== null ? tIdx : -1;
            document.getElementById("taskModal").style.display = "flex";
            
            if(tIdx !== null) {
                const task = appData.sections[sIdx].tasks[tIdx];
                document.getElementById("inputName").value = task.name;
                document.getElementById("inputNote").value = task.note || "";
                document.getElementById("inputStartDate").value = task.startDate || "";
                document.getElementById("inputDueDate").value = task.dueDate || "";
                document.getElementById("inputCurrent").value = task.currentVal || "";
                document.getElementById("inputTarget").value = task.targetVal || "";
                document.getElementById("inputUnit").value = task.unit || "";
                document.getElementById("inputStep").value = task.stepVal || "";
                document.getElementById("inputSubtasks").value = task.subtasks || "";
                document.getElementById("imgBase64").value = task.img || "";
                document.getElementById("imgPreview").innerHTML = task.img ? `<img src="${task.img}" style="height:50px">` : "";
            } else {
                document.querySelectorAll('.form-input').forEach(i => i.value = "");
                document.getElementById("imgBase64").value = "";
                document.getElementById("imgPreview").innerHTML = "";
            }
        }
        function closeModal() { document.getElementById("taskModal").style.display = "none"; }

        function handleImageCompressed(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const maxWidth = 800;
                        let w = img.width; let h = img.height;
                        if (w > maxWidth) { h = Math.round(h * maxWidth / w); w = maxWidth; }
                        canvas.width = w; canvas.height = h;
                        ctx.drawImage(img, 0, 0, w, h);
                        const base64 = canvas.toDataURL('image/jpeg', 0.7);
                        document.getElementById("imgBase64").value = base64;
                        document.getElementById("imgPreview").innerHTML = `<img src="${base64}" style="height:50px">`;
                    }
                }
                reader.readAsDataURL(file);
            }
        }

        async function saveTask() {
            const sIdx = parseInt(document.getElementById("editSectionIndex").value);
            const tIdx = parseInt(document.getElementById("editTaskIndex").value);
            
            const task = {
                name: document.getElementById("inputName").value.trim(),
                note: document.getElementById("inputNote").value,
                startDate: document.getElementById("inputStartDate").value,
                dueDate: document.getElementById("inputDueDate").value,
                currentVal: parseFloat(document.getElementById("inputCurrent").value) || 0,
                targetVal: parseFloat(document.getElementById("inputTarget").value) || 0,
                unit: document.getElementById("inputUnit").value,
                stepVal: parseFloat(document.getElementById("inputStep").value) || 1,
                subtasks: document.getElementById("inputSubtasks").value,
                img: document.getElementById("imgBase64").value,
                done: false,
                id: tIdx !== -1 ? appData.sections[sIdx].tasks[tIdx].id : Date.now()
            };

            if(!task.name) return alert("å†™ä¸ªåå­—å§");

            if(tIdx !== -1) {
                task.done = appData.sections[sIdx].tasks[tIdx].done;
                appData.sections[sIdx].tasks[tIdx] = task;
            } else {
                appData.sections[sIdx].tasks.push(task);
            }
            updateAndSave();
            closeModal();
        }

        function addNewSection() { appData.sections.push({title:"æ–°æ¿å—", collapsed:false, tasks:[]}); updateAndSave(); }
        function deleteSection(idx) { if(confirm("åˆ é™¤æ¿å—?")) { appData.sections.splice(idx,1); updateAndSave(); } }
        async function exportData() {
            const b = new Blob([JSON.stringify(appData)], {type:"application/json"});
            const a = document.createElement("a"); a.href = URL.createObjectURL(b); a.download = `Dzzå¤‡ä»½.json`;
            a.click();
        }
        function importData(inp) {
            const f = inp.files[0]; if(!f) return;
            const r = new FileReader();
            r.onload = async e => { appData = JSON.parse(e.target.result); await updateAndSave(); alert("å·²æ¢å¤"); };
            r.readAsText(f);
        }
    </script>
</body>
</html>
